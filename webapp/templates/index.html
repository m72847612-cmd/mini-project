<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deforestation Watch</title>
    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body class="min-h-screen bg-slate-950 text-white">
    <div class="bg-radial">
      <main class="mx-auto flex max-w-6xl flex-col gap-10 px-6 py-12">
        <section class="grid gap-6 rounded-3xl border border-white/10 bg-white/[0.02] p-10 backdrop-blur">
          <div>
            <p class="inline-flex items-center gap-2 rounded-full border border-emerald-500/30 px-4 py-1 text-sm uppercase tracking-[0.2em] text-emerald-300">
              <span class="h-2 w-2 rounded-full bg-emerald-400"></span>
              Live AI Scoring
            </p>
            <h1 class="mt-6 text-4xl font-semibold leading-tight text-white md:text-5xl">
              Upload a forest scene &mdash; view instant deforestation insights.
            </h1>
            <p class="mt-4 max-w-3xl text-lg text-white/70">
              Our U-Net segmentation model highlights at-risk regions across your satellite imagery. Try a demo image or drop your own capture to create reports within seconds.
            </p>
          </div>
          <div class="grid gap-6 md:grid-cols-3">
            <article class="stat-card">
              <p class="stat-label">Detection threshold</p>
              <p class="stat-value" id="thresholdLabel">50%</p>
              <input
                id="thresholdSlider"
                type="range"
                min="30"
                max="90"
                step="5"
                value="50"
                class="mt-4 w-full accent-emerald-400"
              />
            </article>
            <article class="stat-card">
              <p class="stat-label">Processing speed</p>
              <p class="stat-value text-emerald-300">&lt; 2s</p>
              <p class="stat-subtitle">GPU or Apple Silicon ready</p>
            </article>
            <article class="stat-card">
              <p class="stat-label">Model</p>
              <p class="stat-value">U-Net</p>
              <p class="stat-subtitle">Custom deforestation weights</p>
            </article>
          </div>
        </section>

        <section class="grid gap-6 rounded-3xl border border-white/10 bg-white/[0.02] p-10 backdrop-blur lg:grid-cols-2">
          <div>
            <div class="mb-6 flex items-center justify-between">
              <h2 class="text-2xl font-semibold text-white">1. Upload</h2>
              <button id="demoButton" class="text-sm font-semibold text-emerald-300 hover:text-emerald-200">
                Use demo photo
              </button>
            </div>
            <form id="uploadForm" class="grid gap-5">
              <label
                for="imageInput"
                class="group relative flex min-h-[220px] cursor-pointer flex-col items-center justify-center gap-4 rounded-2xl border-2 border-dashed border-white/20 bg-white/[0.01] p-8 text-center transition hover:border-emerald-400/70 hover:bg-emerald-400/5"
              >
                <input id="imageInput" name="file" type="file" accept="image/*" class="sr-only" />
                <div class="flex h-16 w-16 items-center justify-center rounded-2xl bg-white/5 text-white/70 transition group-hover:text-emerald-200">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4" d="M12 16V4m0 12 3.5-3.5M12 16l-3.5-3.5M7 20h10a3 3 0 0 0 3-3v0a3 3 0 0 0-3-3H7a3 3 0 0 0-3 3v0a3 3 0 0 0 3 3Z" />
                  </svg>
                </div>
                <div>
                  <p class="text-lg font-semibold text-white">Drop image here or browse</p>
                  <p class="text-sm text-white/60">PNG, JPG, TIFF up to ~10MB</p>
                </div>
              </label>
              <div id="previewPanel" class="hidden rounded-2xl border border-white/10 bg-black/40 p-4">
                <p class="mb-3 text-sm uppercase tracking-[0.3em] text-white/60">Preview</p>
                <img id="previewImage" alt="Preview" class="max-h-60 w-full rounded-xl object-cover" />
              </div>
              <div class="flex flex-wrap gap-3">
                <button
                  type="submit"
                  class="btn-primary flex-1"
                >
                  Analyze image
                </button>
                <button
                  type="button"
                  id="resetButton"
                  class="btn-secondary"
                >
                  Reset
                </button>
              </div>
            </form>
            <p class="mt-4 text-sm text-white/60">All processing happens locally on your machine. Images stay private.</p>
          </div>

          <div class="flex flex-col gap-5">
            <div class="flex items-center justify-between">
              <h2 class="text-2xl font-semibold text-white">2. Results</h2>
              <div id="processingBadge" class="hidden items-center gap-2 rounded-full border border-white/20 px-4 py-1 text-sm text-white/70">
                <span class="relative flex h-2 w-2">
                  <span class="absolute inline-flex h-full w-full animate-ping rounded-full bg-emerald-400 opacity-75"></span>
                  <span class="relative inline-flex h-2 w-2 rounded-full bg-emerald-300"></span>
                </span>
                Running inference...
              </div>
            </div>

            <div id="errorBanner" class="hidden rounded-2xl border border-red-400/50 bg-red-500/10 p-4 text-sm text-red-100"></div>

            <div id="resultCards" class="grid gap-4 sm:grid-cols-2">
              <article class="result-card">
                <p class="stat-label">Deforested area</p>
                <p class="stat-value text-rose-300" id="deforestationRate">-- %</p>
                <p class="stat-subtitle" id="deforestedPixels">-- px</p>
              </article>
              <article class="result-card">
                <p class="stat-label">Forest cover</p>
                <p class="stat-value text-emerald-300" id="forestRate">-- %</p>
                <p class="stat-subtitle" id="forestPixels">-- px</p>
              </article>
            </div>

            <div id="visualGrid" class="grid gap-4 md:grid-cols-2">
              <article class="visual-card">
                <p class="stat-label">Model overlay</p>
                <img id="overlayImage" alt="Overlay" class="visual-img" />
              </article>
              <article class="visual-card">
                <p class="stat-label">Mask output</p>
                <img id="maskImage" alt="Mask" class="visual-img" />
              </article>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      const uploadForm = document.getElementById("uploadForm");
      const fileInput = document.getElementById("imageInput");
      const previewPanel = document.getElementById("previewPanel");
      const previewImage = document.getElementById("previewImage");
      const errorBanner = document.getElementById("errorBanner");
      const overlayImage = document.getElementById("overlayImage");
      const maskImage = document.getElementById("maskImage");
      const deforestationRate = document.getElementById("deforestationRate");
      const forestRate = document.getElementById("forestRate");
      const deforestedPixels = document.getElementById("deforestedPixels");
      const forestPixels = document.getElementById("forestPixels");
      const processingBadge = document.getElementById("processingBadge");
      const resetButton = document.getElementById("resetButton");
      const demoButton = document.getElementById("demoButton");
      const thresholdSlider = document.getElementById("thresholdSlider");
      const thresholdLabel = document.getElementById("thresholdLabel");

      const demoImages = [
        "/static/demo/forest_demo_1.png",
        "/static/demo/deforested_example_1.png",
        "/static/demo/unsplash_forest_1.jpg",
        "/static/demo/unsplash_forest_2.jpg",
        "/static/demo/unsplash_forest_3.jpg",
        "/static/demo/unsplash_forest_4.jpg"
      ];

      let currentObjectUrl = null;

      const clearState = () => {
        errorBanner.classList.add("hidden");
        errorBanner.textContent = "";
        overlayImage.src = "";
        maskImage.src = "";
        deforestationRate.textContent = "-- %";
        forestRate.textContent = "-- %";
        deforestedPixels.textContent = "-- px";
        forestPixels.textContent = "-- px";
        if (currentObjectUrl) {
          URL.revokeObjectURL(currentObjectUrl);
          currentObjectUrl = null;
        }
        previewPanel.classList.add("hidden");
      };

      const setPreview = (file) => {
        if (!file) return;
        if (currentObjectUrl) {
          URL.revokeObjectURL(currentObjectUrl);
        }
        currentObjectUrl = URL.createObjectURL(file);
        previewImage.src = currentObjectUrl;
        previewPanel.classList.remove("hidden");
      };

      fileInput.addEventListener("change", () => {
        const file = fileInput.files[0];
        setPreview(file);
      });

      thresholdSlider.addEventListener("input", (event) => {
        thresholdLabel.textContent = `${event.target.value}%`;
      });

      demoButton.addEventListener("click", async () => {
        const imagePath = demoImages[Math.floor(Math.random() * demoImages.length)];
        try {
          const response = await fetch(imagePath);
          const blob = await response.blob();
          const file = new File([blob], imagePath.split("/").pop() || "demo.png", { type: blob.type });
          const dataTransfer = new DataTransfer();
          dataTransfer.items.add(file);
          fileInput.files = dataTransfer.files;
          setPreview(file);
        } catch (error) {
          errorBanner.textContent = "Unable to load demo image. Make sure demo assets exist locally.";
          errorBanner.classList.remove("hidden");
        }
      });

      resetButton.addEventListener("click", () => {
        uploadForm.reset();
        thresholdSlider.value = 50;
        thresholdLabel.textContent = "50%";
        clearState();
      });

      uploadForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        clearState();

        const file = fileInput.files[0];
        if (!file) {
          errorBanner.textContent = "Please choose an image before starting the analysis.";
          errorBanner.classList.remove("hidden");
          return;
        }

        const formData = new FormData();
        formData.append("file", file);
        formData.append("threshold", Number(thresholdSlider.value) / 100);

        processingBadge.classList.remove("hidden");

        try {
          const response = await fetch("/api/predict", {
            method: "POST",
            body: formData
          });

          const payload = await response.json();

          if (!response.ok) {
            throw new Error(payload.detail || "Prediction failed");
          }

          deforestationRate.textContent = `${payload.deforestationRate.toFixed(2)} %`;
          forestRate.textContent = `${payload.forestRate.toFixed(2)} %`;
          deforestedPixels.textContent = `${payload.deforestedPixels.toLocaleString()} px`;
          forestPixels.textContent = `${payload.forestPixels.toLocaleString()} px`;
          overlayImage.src = payload.overlayDataUrl;
          maskImage.src = payload.maskDataUrl;
        } catch (error) {
          errorBanner.textContent = error.message;
          errorBanner.classList.remove("hidden");
        } finally {
          processingBadge.classList.add("hidden");
        }
      });
    </script>
  </body>
</html>


